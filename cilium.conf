helm upgrade cilium cilium/cilium \
  --namespace kube-system \
  --reuse-values \
  --set kubeProxyReplacement=strict \
  --set l7Proxy=true \
  --set envoy.enabled=true \
  --set bgpControlPlane.enabled=true \
  --set loadBalancer.mode=dsr \
  --set loadBalancer.acceleration=native \
  --set operator.replicas=2 \
  --set hubble.enabled=true \
  --set hubble.relay.enabled=true \
  --set hubble.ui.enabled=false \
  --set bpf.lbExternalClusterIP=true
--------------------------------

apiVersion: v1
kind: Service
metadata:
  name: hub-ui-lb
  namespace: kube-system
  annotations:
    io.cilium/lb-ipam-ips: "192.168.1.70"
spec:
  type: LoadBalancer
  selector:
    app: cilium-envoy
  ports:
  - name: https
    port: 443
    targetPort: 443
-------------------------
apiVersion: v1
kind: Service
metadata:
  name: clusters-ui-lb
  namespace: kube-system
  annotations:
    io.cilium/lb-ipam-ips: "192.168.1.71"
spec:
  type: LoadBalancer
  selector:
    app: cilium-envoy
  ports:
  - name: https
    port: 443
    targetPort: 443
------------------

apiVersion: cilium.io/v2
kind: CiliumEnvoyConfig
metadata:
  name: ui-routing
  namespace: kube-system
spec:
  services:
  - name: hub-ui-lb
  - name: clusters-ui-lb
  listeners:
  - name: https
    address: 0.0.0.0
    port: 443
    filterChains:
    - filterChainMatch:
        serverNames: ["*.hub.example.com"]
      filters:
      - name: envoy.filters.network.http_connection_manager
        typedConfig:
          routeConfig:
            virtualHosts:
            - name: hub
              domains: ["*.hub.example.com"]
              routes:
              - match: { prefix: "/" }
                route:
                  cluster: hub-services

    - filterChainMatch:
        serverNames: ["*.cluster.example.com"]
      filters:
      - name: envoy.filters.network.http_connection_manager
        typedConfig:
          routeConfig:
            virtualHosts:
            - name: remote
              domains: ["*.cluster.example.com"]
              routes:
              - match: { prefix: "/" }
                route:
                  cluster: mesh-gateway
------------------------------------------------

node:
  id: envoy-edge-1
  cluster: global-edge

dynamic_resources:
  ads_config:
    api_type: GRPC
    grpc_services:
    - envoy_grpc:
        cluster_name: consul-xds

static_resources:
  clusters:
  - name: consul-xds
    type: logical_dns
    connect_timeout: 5s
    http2_protocol_options: {}
    load_assignment:
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 192.168.1.81
                port_value: 8502

#########################################################


User / Internet / Corp
        |
        | DNS (*.cluster.com)
        v
 +------------------+
 | Envoy VM (x2)    |  <-- GLOBAL EDGE
 | (Consul xDS)     |
 +------------------+
        |
        | VIP targets (not pods)
        v
 +------------------+
 | BGP BIRD2 VM     |  <-- GLOBAL EDGE
 | (Consul xDS)     |
 +------------------+
   |
        | VIP targets (not pods)
        v
 +-----------------------+
 | Cilium L7 (Hub VIPs)  |  <-- K8s Edge
 +-----------------------+
        |
        | SNI routing
        v
 +--------------------------+
 | Hub svc OR               |
 | Mesh Gateway â†’ cluster X |
 +--------------------------+

--------------------------------------------------------------------




                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Internet /  â”‚
                    â”‚ Corporate DNS â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    DNS â†’ two FQDN patterns
                            â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                           â”‚
     VIP #1 (Hub UI)              VIP #2 (Cluster UIs)
     192.168.1.70                 192.168.1.71
     (Bird2 â†’ Cilium)             (Bird2 â†’ Cilium)
              â”‚                           â”‚
        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
        â”‚ Cilium L7 â”‚               â”‚ Cilium L7 â”‚
        â”‚ Envoy     â”‚               â”‚ Envoy     â”‚
        â”‚ (Hub only)â”‚               â”‚ (Remote)  â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
              â”‚                           â”‚
   Hub services (local)          Consul Mesh Gateways
   Rancher / Grafana             (per cluster)
   Consul UI                     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Spoke clusters
                                               (GitLab, UIs, apps)

CONTROL PLANE (separate, stable):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2Ã— Envoy VMs (Proxmox)                   â”‚
â”‚ - Consul XDS (gRPC 8502)                 â”‚
â”‚ - Admin UI (shared)                      â”‚
â”‚ - NO data-plane traffic                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
-------------------------------------------------------




Cluster A user / CI / agent
        |
        | DNS â†’ gitlab.cluster-b.clusters.example.com
        v
BGP VIP (192.168.1.71)  â† advertised by Bird2
        |
        v
Cilium L7 (Hub)
        |
        | ALL *.clusters.example.com
        v
Consul Mesh Gateway (Hub)
        |
        | mTLS + service identity
        v
Mesh Gateway (Cluster B)
        |
        v
GitLab Service (Cluster B)

------------------------------------------
peering 
 Normal operation

            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   DNS      â”‚
            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Bird2 (Site A) â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ VIPs
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Hub A (Cilium +    â”‚
        â”‚ Consul)            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Remote clusters â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
------------------------------------


Hub failure â†’ automatic failover

            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   DNS      â”‚
            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Bird2 (Site B) â”‚  â† iBGP / eBGP
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ VIPs
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Hub B (Replica)    â”‚
        â”‚ (same config)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Remote clusters â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
######################################################################################

prod minimal 
LoadBalancers routing traffic  (advertised by Bird2)
apiVersion: v1
kind: Service
metadata:
  name: hub-ui-lb
  namespace: kube-system
  annotations:
    io.cilium/lb-ipam-ips: "192.168.1.70"
spec:
  type: LoadBalancer
  selector:
    app: cilium-envoy
  ports:
  - name: https
    port: 443
    targetPort: 443
---
apiVersion: v1
kind: Service
metadata:
  name: clusters-ui-lb
  namespace: kube-system
  annotations:
    io.cilium/lb-ipam-ips: "192.168.1.71"
spec:
  type: LoadBalancer
  selector:
    app: cilium-envoy
  ports:
  - name: https
    port: 443
    targetPort: 443

âœ” Bird2 advertises these
âœ” DNS points to these
âœ” They land on Cilium Envoy pods
---
Cilium L7 (single Envoy config, both HUB + clusters)

apiVersion: cilium.io/v2
kind: CiliumEnvoyConfig
metadata:
  name: global-ui-ingress
  namespace: kube-system
spec:
  services:
    - name: hub-ui-lb
    - name: clusters-ui-lb

  listeners:
  - name: https
    address: 0.0.0.0
    port: 443

    filterChains:

    # ===== HUB UIs =====
    - filterChainMatch:
        serverNames:
          - "consul.hub.example.com"
          - "rancher.hub.example.com"
          - "grafana.hub.example.com"
      filters:
      - name: envoy.filters.network.http_connection_manager
        typedConfig:
          stat_prefix: hub_https
          routeConfig:
            virtualHosts:
            - name: hub
              domains:
                - "consul.hub.example.com"
                - "rancher.hub.example.com"
                - "grafana.hub.example.com"
              routes:
              - match: { prefix: "/" }
                route:
                  cluster: hub-services

    # ===== ALL REMOTE CLUSTERS =====
    - filterChainMatch:
        serverNames:
          - "*.clusters.example.com"
      filters:
      - name: envoy.filters.network.http_connection_manager
        typedConfig:
          stat_prefix: remote_https
          routeConfig:
            virtualHosts:
            - name: remote
              domains:
                - "*.clusters.example.com"
              routes:
              - match: { prefix: "/" }
                route:
                  cluster: consul-mesh-gateway

ðŸ”‘ THIS is the scaling trick
Only two clusters defined:

hub-services

consul-mesh-gateway
---

Upstream definitions (where traffic goes)

apiVersion: cilium.io/v2
kind: CiliumEnvoyConfig
metadata:
  name: global-ui-upstreams
  namespace: kube-system
spec:
  clusters:
  - name: hub-services
    type: logical_dns
    connect_timeout: 5s
    lb_policy: round_robin
    load_assignment:
      cluster_name: hub-services
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: hub-ui.platform.svc.cluster.local
                port_value: 443

  - name: consul-mesh-gateway
    type: logical_dns
    connect_timeout: 5s
    lb_policy: round_robin
    load_assignment:
      cluster_name: consul-mesh-gateway
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: mesh-gateway.consul.svc.cluster.local
                port_value: 8443

âœ” Cilium only forwards
âœ” Consul decides destination cluster
---

apiVersion: v1
kind: Service
metadata:
  name: hub-ui
  namespace: platform
spec:
  selector:
    app: platform-ui
  ports:
  - port: 443

This service can front:
Rancher
Consul UI
Grafana
(via internal routing, ingress, or separate vhosts)
-------




