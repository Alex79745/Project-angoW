Perfect ‚Äî this is the right moment to be very explicit and mechanical.
Below is a production-safe, Talos-compatible, OIDC-compatible way to join spokes ‚Üí hub using Submariner OSS, assuming:

‚úÖ Broker already installed in HUB
‚úÖ You are using Talos OS
‚úÖ Omni / OIDC is enabled (humans use OIDC)
‚úÖ Submariner must run in-cluster (not from your laptop)

We‚Äôll do this in clear phases, with exact files and commands.

PHASE 0 ‚Äî What we are building (mental map)

For each SPOKE cluster we will:

Create a ServiceAccount (machine auth)

Create a short-lived token

Build a minimal kubeconfig (NO OIDC)

Store it as a Secret in the HUB

Run a Job in the HUB that executes subctl join

Verify gateways + connectivity

Talos does nothing special here.

PHASE 1 ‚Äî On EACH SPOKE cluster (once per spoke)

These commands are run against the SPOKE cluster API
(from a VM that can reach it, or via Omni exec)

1Ô∏è‚É£ Create namespace
kubectl create namespace submariner-operator

2Ô∏è‚É£ Create ServiceAccount
kubectl -n submariner-operator create serviceaccount submariner-bootstrap

3Ô∏è‚É£ Bind cluster-admin (required by subctl)
# submariner-bootstrap-crb.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: submariner-bootstrap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: submariner-bootstrap
  namespace: submariner-operator

kubectl apply -f submariner-bootstrap-crb.yaml


‚ö†Ô∏è Yes, cluster-admin is required during install.
You can reduce permissions later.

4Ô∏è‚É£ Generate a token (THIS IS CRITICAL)
kubectl -n submariner-operator create token submariner-bootstrap


You should see something like:

eyJhbGciOiJSUzI1NiIsImtpZCI6...


üëâ Save this token (copy it somewhere safe)

5Ô∏è‚É£ Get the SPOKE API server URL
kubectl config view --raw -o jsonpath='{.clusters[0].cluster.server}'


Example:

https://10.0.0.10:6443

6Ô∏è‚É£ Get the CA certificate (Talos-safe way)

Talos does NOT embed CA in kubeconfig when using OIDC.

Use this instead:

kubectl -n kube-system get configmap kube-root-ca.crt \
  -o jsonpath='{.data.ca\.crt}' > ca.crt


Then base64 it:

base64 -w0 ca.crt


Save the output ‚Äî this is your certificate-authority-data.

7Ô∏è‚É£ Create the SPOKE kubeconfig (FILE 1)

üìÑ spoke1.kubeconfig

apiVersion: v1
kind: Config
clusters:
- name: spoke1
  cluster:
    server: https://<SPOKE_API>:6443
    certificate-authority-data: <BASE64_CA>
contexts:
- name: spoke1
  context:
    cluster: spoke1
    user: submariner-bootstrap
current-context: spoke1
users:
- name: submariner-bootstrap
  user:
    token: <TOKEN_FROM_STEP_4>


‚ùó Replace:

<SPOKE_API>

<BASE64_CA>

<TOKEN_FROM_STEP_4>

8Ô∏è‚É£ Validate kubeconfig (VERY IMPORTANT)
kubectl --kubeconfig=spoke1.kubeconfig get nodes


If this fails ‚Üí STOP and fix it.
Submariner will NOT work if this fails.

PHASE 2 ‚Äî Move kubeconfig into the HUB cluster

These commands run against the HUB cluster

9Ô∏è‚É£ Create Secret in HUB
kubectl -n submariner-k8s-broker create secret generic spoke1-kubeconfig \
  --from-file=kubeconfig=spoke1.kubeconfig


Verify:

kubectl -n submariner-k8s-broker get secret spoke1-kubeconfig

PHASE 3 ‚Äî Run subctl JOIN as a Job (HUB)

This avoids laptop / OIDC / Talos issues.

üîü Create the JOIN Job (FILE 2)

üìÑ subctl-join-spoke1.yaml

apiVersion: batch/v1
kind: Job
metadata:
  name: subctl-join-spoke1
  namespace: submariner-k8s-broker
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: subctl
        image: quay.io/submariner/subctl:0.19.1
        command:
        - /bin/sh
        - -c
        - |
          subctl join \
            --kubeconfig /spoke/kubeconfig \
            broker-info.subm \
            --clusterid spoke1 \
            --natt=true
        volumeMounts:
        - name: spoke-kubeconfig
          mountPath: /spoke
      volumes:
      - name: spoke-kubeconfig
        secret:
          secretName: spoke1-kubeconfig


--natt=true is REQUIRED because you have overlapping PodCIDRs.

1Ô∏è‚É£1Ô∏è‚É£ Apply the Job
kubectl apply -f subctl-join-spoke1.yaml


Watch logs:

kubectl -n submariner-k8s-broker logs job/subctl-join-spoke1 -f


You want to see:

‚úì Cluster "spoke1" joined successfully

PHASE 4 ‚Äî Verify Submariner is actually working
1Ô∏è‚É£2Ô∏è‚É£ Check gateway nodes (SPOKE)
kubectl get nodes -l submariner.io/gateway=true

1Ô∏è‚É£3Ô∏è‚É£ Check pods
kubectl -n submariner-operator get pods


You should see:

submariner-gateway

submariner-route-agent

submariner-operator

1Ô∏è‚É£4Ô∏è‚É£ Verify connection in HUB
kubectl -n submariner-k8s-broker get clusters

1Ô∏è‚É£5Ô∏è‚É£ Test pod-to-pod connectivity

Create a test pod in HUB and SPOKE:

kubectl run test --image=busybox -it --restart=Never -- sh


From HUB ‚Üí ping SPOKE pod IP.

If this works ‚Üí network fabric is DONE.

PHASE 5 ‚Äî What happens next (important)

Now:

Pods can talk cross-cluster

Services can be resolved

Consul gossip works

Envoy xDS works

MeshGateways become OPTIONAL

Submariner solved L3/L4
Consul solves L7 + service discovery
Used in managed clusters

Compatible with Talos constraints
###################################################


apiVersion: batch/v1
kind: Job
metadata:
  name: subctl-join
  namespace: submariner-operator
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: submariner-bootstrap
      containers:
      - name: subctl
        image: quay.io/submariner/subctl:0.19.1
        command:
        - /bin/sh
        - -c
        - |
          subctl join \
            broker-info.subm \
            --clusterid spoke1 \
            --natt=true \
            --kubeconfig /var/run/secrets/kubernetes.io/serviceaccount/kubeconfig
        volumeMounts:
        - name: broker
          mountPath: /broker
      volumes:
      - name: broker
        secret:
          secretName: broker-info


#############################################################

$ # Fetch logs from all pods for the job
for p in $(kubectl -n submariner-operator get pods -l job-name=subctl-join -o name); do
  echo "===== LOGS for $p ====="
  kubectl -n submariner-operator logs "$p" --previous || kubectl -n submariner-operator logs "$p"
done
===== LOGS for pod/subctl-join-h29zl =====
Error from server (BadRequest): previous terminated container "subctl" in pod "subctl-join-h29zl" not found
 ‚úì /broker/broker-info.subm indicates broker is at https://kube-omni-klusterx.de.bosch.com/
 ‚úó Error retrieving the default configuration: could not obtain the cluster name from kube config: api.Config{Kind:"", APIVersion:"", Preferences:api.Preferences{Colors:false, Extensions:map[string]runtime.Object{}}, Clusters:map[string]*api.Cluster{}, AuthInfos:map[string]*api.AuthInfo{}, Contexts:map[string]*api.Context{}, CurrentContext:"", Extensions:map[string]runtime.Object{}}

subctl version: release-0.19-260d4934ea54

===== LOGS for pod/subctl-join-l87bn =====
Error from server (BadRequest): previous terminated container "subctl" in pod "subctl-join-l87bn" not found
 ‚úì /broker/broker-info.subm indicates broker is at https://kube-omni-klusterx.de.bosch.com/

############################################################################################


 ‚úó Error retrieving the default configuration: could not obtain the cluster name from kube config: api.Config{Kind:"", APIVersion:"", Preferences:api.Preferences{Colors:false, Extensions:map[string]runtime.Object{}}, Clusters:map[string]*api.Cluster{}, AuthInfos:map[string]*api.AuthInfo{}, Contexts:map[string]*api.Context{}, CurrentContext:"", Extensions:map[string]runtime.Object{}}

subctl version: release-0.19-260d4934ea54

apiVersion: batch/v1
kind: Job
metadata:
  name: subctl-join
  namespace: submariner-operator
spec:
  backoffLimit: 1
  template:
    metadata:
      annotations:
        # Keep Consul injection disabled for this pod
        consul.hashicorp.com/connect-inject: "false"
    spec:
      restartPolicy: Never
      serviceAccountName: submariner-bootstrap
      securityContext:
        seccompProfile:
          type: RuntimeDefault
        runAsNonRoot: true
        runAsUser: 10001
      containers:
      - name: subctl
        image: quay.io/submariner/subctl:0.19.1
        # Call the binary directly ‚Äî no /bin/sh here
        command: ["subctl"]
        args:
          - "join"
          - "/broker/broker-info.subm"
          - "--clusterid"
          - "mas-qa"
          - "--cable-driver"
          - "wireguard"
          - "--natt=true"
          - "--clustercidr"
          - "10.244.0.0/16"
          - "--servicecidr"
          - "10.96.0.0/12"
          # Remove this flag if you DON'T use Globalnet on the broker
          - "--globalnet-cidr"
          - "242.0.2.0/24"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
        volumeMounts:
        - name: broker
          mountPath: /broker
          readOnly: true
      volumes:
      - name: broker
        secret:
          secretName: broker-info
          # Must contain a key named: broker-info.subm



###############################################################
            this should work 
###############################################################

apiVersion: batch/v1
kind: Job
metadata:
  name: subctl-join
  namespace: submariner-operator
spec:
  backoffLimit: 1
  template:
    metadata:
      annotations:
        consul.hashicorp.com/connect-inject: "false"
    spec:
      restartPolicy: Never
      serviceAccountName: submariner-bootstrap
      containers:
      - name: subctl
        image: quay.io/submariner/subctl:0.19.1
        env:
        - name: SUBMARINER_CLUSTERID
          value: mas-qa
        command: ["subctl"]
        args:
          - "join"
          - "/broker/broker-info.subm"
          - "--clusterid"
          - "mas-qa"
          - "--cable-driver"
          - "wireguard"
          - "--natt=true"
          - "--clustercidr"
          - "10.244.0.0/16"
          - "--servicecidr"
          - "10.96.0.0/12"
        volumeMounts:
        - name: broker
          mountPath: /broker
          readOnly: true
      volumes:
      - name: broker
        secret:
          secretName: broker-info


#####################################################
error preisits so i tryied, will it work ?
#####################################################
apiVersion: batch/v1
kind: Job
metadata:
  name: subctl-join
  namespace: submariner-operator
spec:
  backoffLimit: 1
  template:
    metadata:
      annotations:
        consul.hashicorp.com/connect-inject: "false"
    spec:
      restartPolicy: Never
      serviceAccountName: submariner-bootstrap
      securityContext:
        seccompProfile:
          type: RuntimeDefault
        runAsNonRoot: true
        runAsUser: 10001
      # 1) Create a kubeconfig from the SA token & CA
      initContainers:
      - name: make-kubeconfig
        image: busybox:1.36
        command: ["sh","-c"]
        args:
        - |
          set -eu
          # Read SA info
          TOKEN="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
          CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          # Use cluster DNS name; K8s will set these envs automatically.
          HOST="${KUBERNETES_SERVICE_HOST}"
          PORT="${KUBERNETES_SERVICE_PORT}"
          API="https://${HOST}:${PORT}"
          # Write kubeconfig
          cat > /work/kubeconfig <<EOF
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              certificate-authority: ${CA}
              server: ${API}
            name: incluster
          contexts:
          - context:
              cluster: incluster
              user: sa-user
            name: incluster
          current-context: incluster
          users:
          - name: sa-user
            user:
              token: ${TOKEN}
          EOF
          # Permissions and quick check
          chmod 0600 /work/kubeconfig
          echo "Wrote kubeconfig pointing to ${API}"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
          runAsNonRoot: true
          runAsUser: 10001
        volumeMounts:
        - name: work
          mountPath: /work
      # 2) Run subctl using the generated kubeconfig
      containers:
      - name: subctl
        image: quay.io/submariner/subctl:0.19.1
        command: ["subctl"]
        args:
          - "join"
          - "/broker/broker-info.subm"
          - "--kubeconfig"
          - "/work/kubeconfig"
          - "--clusterid"
          - "mas-qa"
          - "--cable-driver"
          - "wireguard"
          - "--natt=true"
          - "--clustercidr"
          - "10.244.0.0/16"
          - "--servicecidr"
          - "10.96.0.0/12"
          # If your broker uses Globalnet, UNCOMMENT the 2 lines below and set a unique CIDR:
          # - "--globalnet-cidr"
          # - "242.0.2.0/24"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
          runAsNonRoot: true
          runAsUser: 10001
        volumeMounts:
        - name: broker
          mountPath: /broker
          readOnly: true
        - name: work
          mountPath: /work
      volumes:
      - name: broker
        secret:
          secretName: broker-info
          # must include a key named "broker-info.subm"
      - name: work
        emptyDir: {}





#####################################################
                     TEST
#####################################################

apiVersion: batch/v1
kind: Job
metadata:
  name: subctl-join
  namespace: submariner-operator
spec:
  backoffLimit: 1
  template:
    metadata:
      annotations:
        consul.hashicorp.com/connect-inject: "false"
    spec:
      restartPolicy: Never
      serviceAccountName: submariner-bootstrap

      initContainers:
      - name: make-kubeconfig
        image: busybox:1.36
        command: ["sh","-c"]
        args:
        - |
          set -eu
          TOKEN="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
          CA_DATA="$(base64 -w0 /var/run/secrets/kubernetes.io/serviceaccount/ca.crt)"
          API="https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}"

          cat > /work/kubeconfig <<EOF
          apiVersion: v1
          kind: Config
          clusters:
          - name: incluster
            cluster:
              server: ${API}
              certificate-authority-data: ${CA_DATA}
          contexts:
          - name: incluster
            context:
              cluster: incluster
              user: sa-user
          current-context: incluster
          users:
          - name: sa-user
            user:
              token: ${TOKEN}
          EOF

          chmod 0600 /work/kubeconfig
          echo "kubeconfig written for ${API}"
        volumeMounts:
        - name: work
          mountPath: /work

      containers:
      - name: subctl
        image: quay.io/submariner/subctl:0.19.1
        env:
        - name: SUBMARINER_CLUSTERID
          value: mas-qa
        command: ["subctl"]
        args:
          - "join"
          - "/broker/broker-info.subm"
          - "--kubeconfig"
          - "/work/kubeconfig"
          - "--clusterid"
          - "mas-qa"
          - "--cable-driver"
          - "wireguard"
          - "--natt=true"
          - "--clustercidr"
          - "10.244.0.0/16"
          - "--servicecidr"
          - "10.96.0.0/12"
        volumeMounts:
        - name: broker
          mountPath: /broker
          readOnly: true
        - name: work
          mountPath: /work

      volumes:
      - name: broker
        secret:
          secretName: broker-info
      - name: work
        emptyDir: {}

#########################################################


###################################################

curl -sSvk --fail \
  --cacert ./omni-ca.crt \
  -H "Authorization: Bearer ${TOKEN}" \
  "https://kube-omni-klusterx.de.corp.com/apis/submariner.io/v1/namespaces/submariner-k8s-broker/clusters" | head
* Uses proxy env variable no_proxy == 'rb-omscloudasl4.server.corp.com,127.0.0.*,localhost'
* Uses proxy env variable https_proxy == 'http://127.0.0.1:3128'
*   Trying 127.0.0.1:3128...
* CONNECT: no ALPN negotiated
* allocate connect buffer
* Establish HTTP proxy tunnel to kube-omni-klusterx.de.corp.com:443
> CONNECT kube-omni-klusterx.de.bosch.com:443 HTTP/1.1
> Host: kube-omni-klusterx.de.bosch.com:443
> User-Agent: curl/8.17.0
> Proxy-Connection: Keep-Alive
>
< HTTP/1.1 200 Connection established
<
* CONNECT phase completed
* CONNECT tunnel established, response 200
* schannel: disabled automatic use of client certificate
* ALPN: curl offers http/1.1
* ALPN: server accepted http/1.1
* Established connection to 127.0.0.1 (127.0.0.1 port 3128) from 127.0.0.1 port 63119
* using HTTP/1.x
> GET /apis/submariner.io/v1/namespaces/submariner-k8s-broker/clusters HTTP/1.1
> Host: kube-omni-klusterx.de.bosch.com
> User-Agent: curl/8.17.0
> Accept: */*
> Authorization: Bearer ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltWTViamhoZUVGTGNWWjRkSGhvWjFKUmRHcEVSa3A2ZDFkQlVHZGphakV6T0VScFZWSllRVU5zU0c4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUp6ZFdKdFlYSnBibVZ5TFdzNGN5MWljbTlyWlhJaUxDSnJkV0psY201bGRHVnpMbWx2TDNObGNuWnBZMlZoWTJOdmRXNTBMM05sWTNKbGRDNXVZVzFsSWpvaWMzVmliV0Z5YVc1bGNpMXJPSE10WW5KdmEyVnlMV0ZrYldsdUxYUnZhMlZ1TFdSM2NHUmlJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpYSjJhV05sTFdGalkyOTFiblF1Ym1GdFpTSTZJbk4xWW0xaGNtbHVaWEl0YXpoekxXSnliMnRsY2kxaFpHMXBiaUlzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJamxtWVRjeU4yUXdMVE0xTjJZdE5HTTRNQzFpTldFMkxUUXlaRGRrTjJKak9HVmlOaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwemRXSnRZWEpwYm1WeUxXczRjeTFpY205clpYSTZjM1ZpYldGeWFXNWxjaTFyT0hNdFluSnZhMlZ5TFdGa2JXbHVJbjAuWUV4SmZYazNwOXFCT1FKQ1oyOXNncFBXaXR0WkFPWXp5TG02OUVZc2ZKdFFreWlwUnZVM2ViZS1mUUtSQlFUTzJVRXRpVVVRTkZOdWkwX2RUdW1XVzljSlg0U2tXU1o1VmVBQU5WUkhvazZIWXdUcFlQb2tmYkV5cl91d3hCQUhRaE4xZFdpUThfdEJINkd1LVVNdzRjRlhXdUVLcUhMWHA4dXFUYTF1d2RMaDFTLXhQZ0U5cVhBakRFVjN1QWFsS3FPQWdiOWl4VmNfYktvc1VwTGdtcjBrTVZKM0NmQW9PQ3JuUFVtYktBMFVOZ2RpMUJpeV9DczlWOWpkQXJZRkxCbXl5SkZkMVdNV2VQck54VFZOak5oc3dKcEVjZFJMVTFhM0hMYzBzdUF0WjJENk9rS01YZkdvZ0Z5SHJaMFYxRXc3LWJTdFNCQ2t0NWhyT0ltU3lQSmNhMUo5U2hCSVFEX2EtT1JKaFNsVVpjYTAzbUhXaklkeTduVGFWRXVrd1hndnlNeW5zUlNNNUhjR0huN0xtTmNkOF9FQXB2ckM3aWVBVUkwNE0xVmRqbXFDWFlZYVFjdnB6c3lENkpkV2RHM05wOGlrd180Q29Ubk5pSkhQOEZCaUpmZlBXT3h2NllBSER6d3EtV2w5cXRtOTJQSlV1VWFrSHFSM2hTWHlNMHUtUThGNWs1cktwZGVpS0ZXa1ZnZ3BFbGJmV2RkY2hta2NfeVg5VjFlTTYxVUI0ZDJJRFlxVFR1cDlRbXN2Ylo5bTVqYzV6N1hMUDIzZlg0VE9QUGF2SnBMU1Jvc3FVX1dFQnlRSHVfNDdQR0dGLUdPN084LWpEZF9YUjloV1FIdXVjQ2ttWV9xRHJwemJueFVfQWtVWkZsX000Q1A0LW14MHdhRDh0T3c=
>
* Request completely sent off
* schannel: remote party requests renegotiation
* schannel: renegotiating SSL/TLS connection
* schannel: SSL/TLS connection renegotiated
* schannel: remote party requests renegotiation
* schannel: renegotiating SSL/TLS connection
* schannel: SSL/TLS connection renegotiated
< HTTP/1.1 401 Unauthorized
< Server: nginx/1.24.0 (Ubuntu)
< Date: Fri, 30 Jan 2026 11:06:34 GMT
< Content-Type: text/plain; charset=utf-8
< Content-Length: 44
< Connection: keep-alive
* The requested URL returned error: 401
<
* closing connection #0
curl: (22) The requested URL returned error: 401
_______________________________________________________________



apiVersion: v1
kind: Pod
metadata:
  name: regenerate-brokerinfo
  namespace: submariner-k8s-broker
spec:
  restartPolicy: Never
  # This SA must already exist (created by subctl deploy-broker)
  serviceAccountName: submariner-k8s-broker-admin
  containers:
  - name: generate
    image: busybox:1.36
    command: ["sh","-c"]
    args:
      - |
        set -eu
        TOKEN="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
        NS="$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)"
        CA_B64="$(base64 /var/run/secrets/kubernetes.io/serviceaccount/ca.crt | tr -d '\n')"
        NS_B64="$(printf "%s" "$NS" | base64 | tr -d '\n')"

        # NOTE: If you need IPsec PSK and the secret exists, uncomment the kubectl line below and use a kubectl image.
        # For now we leave PSK empty (not needed for WireGuard).
        PSK_B64=""

        mkdir -p /work

        # Build a minimal, valid broker-info bundle that uses in-cluster API
        cat > /work/broker-info.subm <<EOF
{"brokerURL":"https://kubernetes.default.svc:443",
 "clientToken":{"metadata":{"name":"submariner-k8s-broker-admin-token","namespace":"${NS}","annotations":{"kubernetes.io/created-by":"regenerate-brokerinfo","kubernetes.io/service-account.name":"submariner-k8s-broker-admin"}},
               "data":{"ca.crt":"${CA_B64}","namespace":"${NS_B64}","token":"${TOKEN}"},
               "type":"kubernetes.io/service-account-token"},
 "ipsecPSK":{"metadata":{"name":"submariner-ipsec-psk"},"data":{"psk":"${PSK_B64}"}},
 "serviceDiscovery":true,
 "Components":["connectivity","service-discovery"]}
EOF
        echo "Wrote /work/broker-info.subm"
        sleep 3600
    volumeMounts:
    - name: work
      mountPath: /work
  volumes:
  - name: work
    emptyDir: {}

############################################
################################################


##################################################


apiVersion: v1
kind: Pod
metadata:
  name: regenerate-brokerinfo
  namespace: submariner-k8s-broker
spec:
  restartPolicy: Never
  serviceAccountName: submariner-k8s-broker-admin
  containers:
  - name: generate
    image: quay.io/submariner/subctl:0.18.0
    command: ["sh","-c"]
    args:
      - |
        set -eu

        CA_B64="$(base64 /var/run/secrets/kubernetes.io/serviceaccount/ca.crt | tr -d '\n')"

        cat > /work/broker-info.subm <<EOF
{
  "brokerURL": "https://kubernetes.default.svc",
  "clientToken": {
    "metadata": {
      "name": "submariner-k8s-broker-admin-token",
      "namespace": "submariner-k8s-broker"
    }
  },
  "serviceDiscovery": true,
  "Components": ["connectivity","service-discovery"]
}
EOF

        echo "broker-info.subm generated"
        sleep 3600
    volumeMounts:
    - name: work
      mountPath: /work
  volumes:
  - name: work
    emptyDir: {}
